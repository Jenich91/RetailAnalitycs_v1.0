# RetailAnalytics v1.0

Разработка на языке программирования PL/pgSQL базы данных со знаниями о клиентах розничных сетей, а также представлений и процедур, необходимых для создания персональных предложений ориентированных на рост среднего чека, ориентированных на рост частоты визитов, ориентированных на кросс-продажи.

## Logical view of database model

Были созданы и описаны структуры нескольких таблиц:

Таблица "Персональные данные":
    - Включает данные о клиенте, такие как идентификатор, имя, фамилия, электронная почта и телефон.
    - Каждое поле имеет свой формат ввода и возможные значения.

Таблица "Карты":
    - Содержит информацию о картах клиентов, каждая из которых связана с идентификатором клиента.

Таблица "Транзакции":
    - Содержит данные о совершенных транзакциях, включая идентификатор транзакции, карты, сумму, дату/время и место проведения транзакции.

Таблица "Чеки":
    - Детализирует информацию о совершенных транзакциях, предоставляя более подробные сведения о каждом чеке.

Таблица "Торговые точки" содержит данные о товарах, их закупочной и розничной стоимости для каждой торговой точки.

Таблица "Группы SKU" включает в себя сведения о группах товаров (SKU), предоставляя уникальный идентификатор и название группы.

Таблица "Дата формирования анализа" представляет собой информацию о дате формирования анализа.

Эти таблицы были созданы для хранения информации о клиентах, их карт, транзакциях и чеках, облегчая работу с операциями и анализом данных клиентов и их финансовых активностей.

Представление "Клиенты" включает в себя значительное количество метрик, включающих средний чек, частоту покупок, период неактивности клиента, коэффициент оттока, а также их соответствующие сегменты, предоставляя дополнительные информации о поведении и активности клиентов.

Таблица "История покупок":
    - Включает информацию о транзакциях, связанных с клиентами, а также детали каждой транзакции, такие как идентификатор клиента, идентификатор транзакции, дата и время совершения транзакции, идентификатор группы товаров, их себестоимость, базовая розничная стоимость и фактически оплаченная стоимость.
    - Это представление содержит подробную информацию о покупках клиентов, включая информацию о совершенных транзакциях, группе товаров и стоимости каждой покупки.

Таблица "История покупок":
    - Содержит дополнительные данные о клиентах, включая номер сегмента, к которому принадлежит клиент, и идентификатор основного магазина клиента.
    - Это представление содержит дополнительные атрибуты, которые могут быть использованы для классификации и анализа клиентов.

В результате была создана структура, позволяющая более детально анализировать и классифицировать клиентов с целью более точной сегментации и анализа поведения клиентской базы в рамках торговой сети.

Представление "Периоды" включает информацию о клиенте и его группе товаров. Для каждой группы товаров указаны дата первой и последней покупки, количество транзакций, интенсивность покупок и минимальный размер скидки для данной группы.

Представление "Группы" предоставляет более детальную информацию о группе товаров, включая идентификатор клиента, идентификатор группы товаров и остальные характеристики, такие как дата первой и последней покупки в группе, количество транзакций, интенсивность покупок и минимальный размер скидки.

Оба представления были разработаны для облегчения анализа и обработки данных о покупках клиентов по временным периодам и группам товаров, позволяя лучше понять покупательское поведение и предпочтения клиентов.

Представление "Периоды"
В данном представлении содержится информация о клиенте и его группе товаров. Для каждой группы товаров указана дата первой и последней покупки, количество транзакций, интенсивность покупок и минимальный размер скидки для данной группы.

Представление "Группы"
Это представление предоставляет более детальную информацию о группе товаров. Оно включает идентификатор клиента, идентификатор группы товаров и другие характеристики, такие как дата первой и последней покупки в группе, количество транзакций, интенсивность покупок и минимальный размер скидки.

Оба представления были разработаны для облегчения анализа данных о покупках клиентов по временным периодам и группам товаров, позволяя лучше понять покупательское поведение и предпочтения клиентов.

## Создание базы данных

Скрипт part1.sql для создания базы данных и таблиц, добавления данных, и создания представлений для анализа данных о клиентах и их покупках. Были описаны таблицы "CustomerPersonalData" и "PurchaseHistory", после чего в них были внесены данные.

## Создание представлений

Дополнительно, были созданы представления "Customers" и "PurchaseHistoryView" для более удобного анализа данных. Кроме этого, в скрипт были добавлены процедуры импорта и экспорта данных из файлов в базу данных с использованием форматов CSV/TSV, а также были включены тестовые запросы для представлений.


## Ролевая модель

В скрипте part3.sql были созданы роли и предоставлены им соответствующие права в соответствии с описаниями ниже:

Администратор
- У администратора есть полные права на редактирование и просмотр любой информации, а также на запуск и остановку процесса обработки.

Посетитель
- Посетитель имеет право только на просмотр информации из всех таблиц.

## Формирование персональных предложений, ориентированных на рост среднего чека

Создан скрипт part4.sql, в который внесена описанная ниже функция:
Функция определяет предложения, ориентированные на рост среднего чека, с учетом следующих параметров:
    - Метод расчета среднего чека (за период, за количество)
    - Первая и последняя даты периода (для метода 1)
    - Количество транзакций (для метода 2)
    - Коэффициент увеличения среднего чека
    - Максимальный индекс оттока
    - Максимальная доля транзакций со скидкой
    - Допустимая доля маржи
Функция также определяет условия предложения, включая выбор метода расчета и определение целевого значения среднего чека на основе коэффициента, заданного пользователем.

Был разработан процесс определения группы для формирования вознаграждения с учётом следующих критериев:
    1. Выбор группы для формирования вознаграждения осуществляется по следующим критериям:
- Индекс востребованности группы – выбирается группа с максимальным индексом востребованности.
- Индекс оттока по данной группе не должен превышать заданного пользователем значения. В случае, если коэффициент оттока превышает установленное значение, берется следующая по индексу востребованности группа.
- Доля транзакций со скидкой по данной группе – должна быть менее заданной пользователем доли. В случае, если для выбранной группы доля транзакций со скидкой превышает установленное значение, выбирается следующая по индексу востребованности группа, удовлетворяющая также критерию по оттоку.

    2. После выбора подходящей группы определяется максимально допустимый размер скидки для вознаграждения. Пользователь вручную устанавливает долю маржи (в процентах), которую можно использовать для предоставления вознаграждения по группе. Итоговое значение максимально допустимой скидки рассчитывается путем умножения заданного значения на среднюю маржу клиента по группе.

    3. Затем определяется величина скидки. Значение, полученное на предыдущем шаге, сравнивается с минимальной скидкой, которая была зафиксирована для клиента по данной группе, округленной вверх с шагом в 5%. Если минимальная скидка после округления меньше полученного значения, она устанавливается в качестве скидки для группы в рамках предложения для клиента. В противном случае процесс повторяется, начиная с выбора следующей подходящей по критериям группы для формирования предложения.

4. Индекс оттока по группе не должен превышать заданного пользователем значения, а индекс стабильности потребления группы должен составлять менее указанного пользователем значения.

5. Далее происходит определение SKU (Stock Keeping Unit) с максимальной маржой в каждой группе. Это достигается путем вычитания закупочной стоимости (SKU_Purchase_Price) из розничной цены товара (SKU_Retail_Price) для всех SKU данной группы в основном магазине клиента. После этого выбирается одно SKU с максимальной разницей между ценами.

6. Определяется доля SKU в группе. Расчитывается доля транзакций, в которых присутствует анализируемое SKU. SKU используется для формирования предложения только при условии, что получившееся значение не превышает заданной пользователем доли.

7. Затем происходит определение доли маржи для расчета скидки. Пользователь определяет долю маржи (в процентах), которую можно использовать для предоставления вознаграждения по SKU (задается единое значение для всех клиентов).

8. В завершение происходит расчёт скидки. Заданное пользователем значение умножается на разницу между розничной (SKU_Retail_Price) и закупочной (SKU_Purchase_Price) ценой, и полученное значение делится на розничную цену SKU (SKU_Retail_Price) для основного магазина клиента. Если получившееся значение равно или превышает минимальный размер скидки пользователя для анализируемой группы, то в качестве скидки для данного SKU устанавливается минимальная скидка для группы, округленная вверх с шагом в 5%. В противном случае клиенту не формируется предложение по данной группе.

## Формирование персональных предложений, ориентированных на рост частоты визитов
Был создан скрипт part5.sql, в котором была реализована функция для определения предложений, ориентированных на рост частоты визитов. Функция принимает следующие параметры:
- Первая и последняя даты периода
- Добавляемое число транзакций
- Максимальный индекс оттока
- Максимальная доля транзакций со скидкой (в процентах)
- Допустимая доля маржи (в процентах)

Процесс определения условия предложения включает следующие шаги:
1. Определение периода действия предложения, когда пользователь вручную задает первую и последнюю даты периода.
2. Расчёт текущей частоты посещений клиента в заданный период.
3. Определение транзакции для начисления вознаграждения.

Определение вознаграждения включает:
1. Выбор группы для формирования вознаграждения с учетом нескольких критериев, таких как индекс востребованности группы, индекс оттока и доля транзакций со скидкой.
2. Определение максимально допустимого размера скидки для вознаграждения.
3. Определение величины скидки.

## Формирование персональных предложений, ориентированных на кросс-продажи
Для part6.sql была создана функция, которая определяет предложения, ориентированные на кросс-продажи с целью роста маржи. Эта функция принимает в качестве параметров:
- Количество групп
- Максимальный индекс оттока
- Максимальный индекс стабильности потребления
- Максимальная доля SKU (в процентах)
- Допустимая доля маржи (в процентах)

Процесс формирования предложений ориентирован на переключение клиента на максимально маржинальное SKU в рамках востребованной им группы.Выбор групп для этих предложений осуществляется в соответствии с определенными условиями, включающими максимальный индекс востребованности, индекс оттока, индекс стабильности потребления и максимальную долю SKU.
